(function($){"use strict";window.ItemEditor=React.createClass({displayName:"ItemEditor",statics:{toMap:function(hallIdArray){if(!hallIdArray)return{};var ret={};return hallIdArray.forEach(function(hallId){ret[hallId]="dummy"}),ret}},getInitialState:function(){return{id:this.props.data.id,name:this.props.data.name,unitPrice:this.props.data.unitPrice,description:this.props.data.description,categoryId:this.props.data.categoryId,belongHalls:[],url:this.props.data.id?"/items/"+this.props.data.id+"___"+this.props.data.imageTimestamp+"/image":"/img/unset.png",messageVisible:!1,messageText:"",indicatorFor:null,indicatorActive:!1}},handleCloseClick:function(){this.props.onCloseClick&&this.props.onCloseClick({})},handleNameChange:function(e){this.setState({name:e.target.value})},handleUnitPriceChange:function(e){this.setState({unitPrice:e.target.value})},handleDescriptionChange:function(e){this.setState({description:e.target.value})},handleCategoryChange:function(e){this.setState({categoryId:e.target.value})},handleHallCheckChange:function(index,e){this.state.belongHalls[index].checked=e.target.checked,this.setState({belongHalls:this.state.belongHalls})},handleFileSelect:function(files){if(0!==files.length){var fr=new FileReader;$(fr).on("load",function(e){this.setState({url:e.target.result,indicatorActive:!1})}.bind(this)),this.setState({indicatorFor:React.findDOMNode(this.refs.image),indicatorActive:!0}),fr.readAsDataURL(files[0])}},handleDragOver:function(e){this.cancel(e)},handleDrop:function(e){try{if(!e.dataTransfer)return;var files=e.dataTransfer.files;if(!files)return;this.handleFileSelect(files)}finally{this.cancel(e)}},handleFileChange:function(e){var files=e.target.files;files&&this.handleFileSelect(files)},handleSubmit:function(e){var name=React.findDOMNode(this.refs.name).value,unitPrice=React.findDOMNode(this.refs.unitPrice).value,imageDataUrl=$(React.findDOMNode(this.refs.image)).attr("src");0!==imageDataUrl.indexOf("data:")&&(imageDataUrl="noop");var catId=React.findDOMNode(this.refs.category).value;"null"===catId&&(catId=null);var desc=React.findDOMNode(this.refs.description).value,hallIds=[];this.state.belongHalls.forEach(function(belongHall){belongHall.checked&&hallIds.push(belongHall.id)});var url=this.state.id?"/items/"+this.state.id:"/items/";this.setState({indicatorFor:React.findDOMNode(this.refs.form),indicatorActive:!0}),$.ajax({url:url,type:"post",data:{name:name,unitPrice:unitPrice,imageDataUrl:imageDataUrl,categoryId:catId,belongHallIds:hallIds.join(","),description:desc},success:function(response){return"OK"!==response.status?(this.setState({messageVisible:!0,messageText:response.message,indicatorActive:!1}),void 0):(this.setState({visible:!1,indicatorActive:!1}),"INSERT"===response.operation?this.props.onInsert&&this.props.onInsert({}):this.props.onUpdate&&this.props.onUpdate({}),void 0)}.bind(this),fail:function(){this.setState({indicatorActive:!1}),console.log(arguments)}}),e.preventDefault()},cancel:function(e){return e.preventDefault(),e.stopPropagation(),!1},componentDidUpdate:function(prevProps){if(prevProps.data!==this.props.data&&this.setState({id:this.props.data.id,name:this.props.data.name,unitPrice:this.props.data.unitPrice,categoryId:this.props.data.categoryId?this.props.data.categoryId:"",description:this.props.data.description?this.props.data.description:"",url:this.props.data.id?"/items/"+this.props.data.id+"___"+this.props.data.imageTimestamp+"/image":"/img/unset.png"}),prevProps.belongHallIds!==this.props.belongHallIds||prevProps.halls!==this.props.halls){var belongSet={};this.props.belongHallIds.forEach(function(belongHallId){belongSet[belongHallId]="dummy"});var belongHalls=[];this.props.halls.forEach(function(hall){hall.checked=hall.id in belongSet,belongHalls.push(hall)}),this.setState({belongHalls:belongHalls})}this.props.visible?$(".item-editor-dialog").modal("show"):$(".item-editor-dialog").modal("hide")},render:function(){var categoriesData=[{id:"null",name:"(カテゴリなし)"}].concat(this.props.categories.concat()),categories=categoriesData.map(function(category){return React.createElement("option",{key:"category_"+category.id,value:category.id},category.name)}),halls=this.state.belongHalls.map(function(hall,index){return React.createElement("label",{key:"hallName_"+hall.id,className:"hall-name"},React.createElement("input",{type:"checkbox",value:hall.id,checked:this.state.belongHalls[index].checked,onChange:this.handleHallCheckChange.bind(this,index)}),hall.name)}.bind(this));return!!this.state.url,React.createElement("div",{className:"ItemEditor"},React.createElement("div",{className:"item-editor-dialog modal fade"},React.createElement("div",{className:"modal-dialog"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("button",{className:"close",onClick:this.handleCloseClick,"aria-label":"Close"},React.createElement("span",{"aria-hidden":"true"},"×")),React.createElement("h4",{className:".item-editor-dialog-title modal-title"},"アイテム編集")),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"message"},this.state.messageText),React.createElement("form",{className:"item-edit-form",ref:"form",onDragOver:this.handleDragOver,onDrop:this.handleDrop},React.createElement("div",{className:"form-group"},React.createElement("input",{type:"text",ref:"name",className:"item-name form-control",value:this.state.name,placeholder:"アイテム名",onChange:this.handleNameChange})),React.createElement("div",{className:"form-group"},React.createElement("input",{type:"number",ref:"unitPrice",className:"form-control",value:this.state.unitPrice,placeholder:"単価",onChange:this.handleUnitPriceChange})),React.createElement("div",{className:"form-group"},React.createElement("select",{className:"form-control",ref:"category",value:this.state.categoryId,onChange:this.handleCategoryChange},categories)),React.createElement("div",{className:"form-group"},React.createElement("textarea",{className:"item-description form-control",ref:"description",value:this.state.description,placeholder:"説明",onChange:this.handleDescriptionChange})),React.createElement("div",{className:"form-group"},React.createElement("img",{src:this.state.url,className:"item-image",ref:"image"}),React.createElement("div",null,React.createElement("span",null,"画像をドラッグ＆ドロップ"),"または",React.createElement("div",{className:" file-overlay btn btn-success"},React.createElement("i",{className:"glyphicon glyphicon-white glyphicon-file"}),"ファイルを選択",React.createElement("input",{type:"file",className:"dnd-file",onChange:this.handleFileChange}))),React.createElement(Indicator,{buttonRef:this.state.indicatorFor,active:this.state.indicatorActive})),React.createElement("div",{className:"form-group"},React.createElement("h3",null,"所属会場"),halls))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{className:"item-editor-close-button btn btn-default",onClick:this.handleCloseClick},React.createElement("i",{className:"glyphicon glyphicon-remove"}),"キャンセル"),React.createElement("button",{className:"btn btn-primary",onClick:this.handleSubmit},React.createElement("i",{className:"glyphicon glyphicon-ok"}),"変更を保存"))))))}}),window.Item=React.createClass({displayName:"Item",handleItemClick:function(e){try{this.props.onItemClick&&this.props.onItemClick({data:this.props.data})}finally{e.preventDefault(),e.stopPropagation()}},handleEditClick:function(e){try{this.props.onEditClick&&this.props.onEditClick({data:this.props.data})}finally{e.preventDefault(),e.stopPropagation()}},handleRemoveClick:function(e){try{this.props.onRemoveClick&&this.props.onRemoveClick({data:this.props.data})}finally{e.preventDefault(),e.stopPropagation()}},render:function(){var imageUrl;return imageUrl=this.props.data.id?"/items/"+this.props.data.id+"___"+this.props.data.imageTimestamp+"/image":"/img/unset.png",React.createElement("div",{className:"Item",onClick:this.handleItemClick},React.createElement("div",{className:"tool-box"},this.props.editable?React.createElement("button",{className:"btn",onClick:this.handleEditClick},React.createElement("i",{className:"glyphicon glyphicon-pencil"})):null,this.props.editable?React.createElement("button",{className:"btn",onClick:this.handleRemoveClick},React.createElement("i",{className:"glyphicon glyphicon-remove-sign"})):null),React.createElement("fieldset",{className:"fields"},React.createElement("legend",null,React.createElement("span",{className:"item-name"},this.props.data.name),React.createElement("span",{className:"item-unit-price"},"単価：",(this.props.data.unitPrice+"").replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),"円")),React.createElement("img",{src:imageUrl,className:"item-image"}),React.createElement("p",{className:"item-description"},this.props.data.description)))}}),window.ItemList=React.createClass({displayName:"ItemList",handleAddClick:function(){this.props.onAddClick&&this.props.onAddClick()},handleItemClick:function(e){this.props.onItemClick&&this.props.onItemClick(e)},handleItemEditClick:function(e){this.props.onItemEditClick&&this.props.onItemEditClick(e)},handleItemRemoveClick:function(e){this.props.onItemRemoveClick&&this.props.onItemRemoveClick(e)},render:function(){var items=this.props.items.map(function(item){return React.createElement("li",{key:"item-list_"+item.id},React.createElement(Item,{key:"item_"+item.id,data:item,editable:this.props.editable,onItemClick:this.handleItemClick,onEditClick:this.handleItemEditClick,onRemoveClick:this.handleItemRemoveClick}))}.bind(this)),classes={ItemList:!0};return classes["col-md-"+(this.props.cols?this.props.cols:12)]=!0,React.createElement("div",{className:React.addons.classSet(classes)},React.createElement("div",{className:"tool-box"},this.props.editable?React.createElement("button",{className:"btn btn-default tool-box-button",onClick:this.handleAddClick},React.createElement("i",{className:"glyphicon glyphicon-plus"})):null),React.createElement("h2",{className:0===this.props.items.length?"add-message":"hidden"},"アイテムを追加して下さい。"),React.createElement("ul",{className:"item-list"},items))}})})(jQuery);